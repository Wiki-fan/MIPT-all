\input{boilerplate.tex}

\date{}

\usepackage[]{algorithm2e}

\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
		\node[shape=circle,draw,inner sep=2pt] (char) {#1};}}
	
\newtheorem{theorem}{Теорема}

\renewcommand{\G}{\mathcal{G}}
\begin{document}
\bibliographystyle{unsrt}
%\bibliographystyle{gost780s}

\paragraph{Введение}
Пусть дан полный граф $K_n = (V, E)$ с весами рёбер $c \in \R^E$. \textit{Задача коммивояжёра}(TSP) заключается в том, чтобы найти гамильтонов цикл (обход) в G минимальной стоимости. Если $c_{ij} = c_{ji} \forall (i, j)  \in E$, говорят, что задача симметрична. 

Если веса рёбер удовлетворяют неравенству треугольника, говорят о метрической задаче коммивояжёра. Метрическая задача коммивояжёра --- одна из старейших известных NP-полных задач (доказательство NP-полноты см. в \cite{JP85}). Наилучший известный сейчас результат --- приближение с точностью $\frac{3}{2}$\cite{C76}. 

Внимания заслуживает случай симметричной задачи коммивояжёра с весами 1 и 2, называемый (1,2)-TSP. Поскольку $\forall a, b, c \in \{1, 2\} \ a\le b+c$, неравенство треугольника всегда выполняется, и это --- подкласс метрической задачи коммивояжёра. (1, 2)-TSP можно рассматривать как обобщение задачи о гамильтоновом пути, требующее наличия в гамильтоновом пути как можно меньшего количества рёбер веса 2. Отсюда следует, что (1,2)-TSP NP-полно \cite{K72}. 

Было доказано \cite{EK01}, что нельзя построить приближение лучше $\frac{741}{740}$. Наилучший известный алгоритм Пападимитриу-Яннакакиса \cite{PY93} предоставлял приближение $7/6$ и был незначительно улучшен до $65/56$ \cite{BR05}. 

\paragraph{\NP-полнота}
Поставим задачу формально .

TSP $= \{ (G, \mathbf{w}, k): \exists$ цикл во взвешенном графе $(G, \mathbf{w})$, посещающий каждую вершину ровно 1 раз и имеющий вес $\le k \}$

\begin{theorem}
	TSP --- \NP-полно.
\end{theorem}
\begin{proof}
 $ $\newline
 \begin{itemize}
  \i TSP $\in \NP$\cite{BA09}:
 
  Сертификатом является собственно обход. За полиномиальное время проверяется, что такой обход в графе действительно существует, и что его длина $\le k$.
 
  \i UHAMPATH $\le_p$ TSP:
 
  Сопоставим всем рёбрам единичные веса и возьмём $k = n$. Путь длины $n$, проходящий через все вершины, обязан быть гамильтоновым.
 \end{itemize}
\end{proof}

\paragraph{Эквивалентная формулировка}
Представим экземпляр задачи (1,2)-TSP как граф $G$, вершины которого --- точки метрики, а рёбра --- пары вершин на расстоянии 1. Пусть в $G$ $n$ вершин, и можно найти его покрытие $k$ путями (простыми и вершинно непересекающимися). Тогда эти пути содержат $n-k$ рёбер и их можно соединить в обход, где ребро из конца одного пути в начало другого будет иметь вес 2. Стоимость обхода будет $n+k$, задача --- минимизировать $k$. Если оптимальное решение содержит $n+k^*$ рёбер, нам нужно найти покрытие путями из $\le \frac{1}{7}n+\frac{8}{7}k^*$ путей. Будем далее решать такую задачу.

\paragraph{Алгоритм малых улучшений}
Будем поддерживать текущее решение алгоритма как множество рёбер $A$ ("algorithm"), являющееся 2-паросочетанием (то есть, у вершины может быть не более двух инцидентных ей рёбер из $A$). Пусть в нём $k_A$ путей и циклов, $m_A$ вершин в циклах, $s_A$ синглтонов (т. е. компонент связности размера 1). Это решение можно преобразовать с помощью множества вершин $C$ ("change") в новое решение $A \oplus C$. $C$ улучшает $A$, если 
\begin{enumerate}
	\i $A \oplus C$ --- 2-паросочетание;
	\i $k_{A \oplus C} < k_A$ или
	\i $k_{A \oplus C} = k_A$ и $m_{A \oplus C} > m_A$, или
	\i $k_{A \oplus C} = k_A$ и $m_{A \oplus C} = m_A$ и $s_{A \oplus C} < s_A$
\end{enumerate}

Алгоритм K-IMPROV:

\begin{algorithm}[H]
 A = $\emptyset$\;
 \While{$\exists C, |C|<K, C$ улучшает $A$}{
  $A \gets A \oplus C$\;
 }
\end{algorithm}

Предположим, что для некоторой константы $K$ выполняется 
$$(*) \text{ либо } k_A \le \frac{1}{7}n+\frac{8}{7}k^*, \text{ либо } \exists C: C \text{ улучшает } A \textbf{ и } |C|\le K.$$
Нельзя провести более чем $n$ улучшений вида 2, т. к. число путей и циклов получится $\le0$.

Нельзя провести более чем $n$ последовательных подряд без улучшения вида 1, т. к. в циклах получится $>n$ вершин.

Нельзя провести более чем $n$ последовательных улучшений вида 3, т. к. иначе будет $<= 0$ изолированных вершин. 

То есть, можно провести не более чем $n^3$ улучшений. Поиск каждого улучшения занимает $O(n^K)$ шагов.

Проверка всех пунктов 1) --- 4) занимает $O(n)$.

Перебор всех допустимых вариантов $C$ в самой простой реализации (перебор всех подмножеств множества рёбер) занимает $O((n^2)^K)$. Заметим, что если $C$ состоит из двух компонент связности, то улучшение, которое он может дать, разбивается на два улучшения. Поэтому достаточно смотреть только $C$, состоящие из одного простого пути. Их $O(n^K)$. Окончательно, время работы K-IMPROV составляет $O(n^{K+4})$.

\paragraph{Доказательство утверждения (*)}
Зафиксируем оптимальное решение, 2-паросочетание $B$ ("best"), т. ч. $k_B = k^*$. Пусть $D$ --- множество рёбер, оба конца которых лежат в одном и том же цикле $A$. Пусть $\G$, \textit{вспомогательный граф}, --- граф, содержащий вершины графа $G$ и рёбра $(A \cup B) \setminus D$. Покрасим его рёбра в три цвета.
Белые $A \setminus B \setminus D$, чёрные $B \setminus A \setminus D$ и серые $(A \cap B) \setminus D$. 

Назовём \textit{чередующимся путём} (ЧП) путь, начинающийся и заканчивающийся в чёрной вершине, в котором чёрные и белые вершины чередуются.

Пути и циклы $A$ назовём A-объектами. Для A-объекта определим \textit{начальную вершину} как вершину, которая может быть первой или последней вершиной ЧП и при этом \textit{принадлежит} A-объекту. Для A-пути, начальные вершины --- его концы. Для A-цикла $C$ возьмём за начальные вершины такие две, что в $C$ существует гамильтонов путь из одной в другую, который может быть продолжен двумя чёрными рёбрами до двух других вершин. 

Покажем, что такая пара всегда найдётся в A-цикле из менее 8 вершин.

Введём понятие \textit{фишки обоснования}. Это абистрактная делимая единица, которая ассоциирована с вершинами. Изначальное распределение фишек задаётся весами вершин. Общее количество фишек --- сумма этих весов.
Если $B$ состоит из $k^*$ путей, оптимум имеет стоимость $n+k^*$ и A даёт достаточное приближение, если она имеет стоимость $\le \frac{8}{7}(n+k^*)$, т. е. если она состоит из $\le \frac{1}{7} + \frac{8}{7}k^*$ A-объектов. Создадим $n+8k^*$ фишек и докажем, что для того, чтобы A было достаточно хорошим приближением, каждый A-объект должен содержать 8 точек.
Вершина, инцидентная $2-a$ вершинам B, содержит $1+4а$ фишек (сумма их всех $2k^*$). Изначально фишки пути есть фишки его концов и фишки цикла есть фишки всех его вершин. Оставшиеся фишки содержатся в ЧП. ЧП даёт фишки тем A-объектам, которые содержат его начальные вершины. После "разбиения" ЧП, они могут содержать только одну начальную вершину, и поэтому дают свои фишки только одному A-объекту.

Обычно, А-путь содержит два конца, и каждый из них --- начальная вершина ЧП, который даёт этому пути $2
frac{1}{2}$ фишек. Похожим образом, цикл обычно содержит $4+a$ вершин и содержит 2 начальных верин ЧП, которые дают циклу $\frac{3-a}{2}$ вершин. 

Могут быть отклонения от обычного случая. Если А-объект содержит менее 2-х начальных вершин, он собирает больше фишек с вершин, которые он содержит. Если А-объект --- синглтон, то каждая начальная вершина даёт ему 3 фишки. Если цикл содержит более 6 вершин, в нём не будет начальных вершин. Вершина, инцидентная только одному ребру из $B$ имеет 4 дополнительных фишки, и мы будем опускать особые случаи, вызванные такими вершинами.

\paragraph{Очень маленькие улучшения}
В некоторых случаях возможны улучшения, вставляющие только одно ребро. Обсудим их, а дальше будем предполагать, что они не встречаются.

Чёрное ребро $e$, соединяющее две начальные вершины. Если оно соединяет два разных А-обхекта, они сливаются в один. Если сливаемый объект-цикл, приходится удалить одно из его рёбер. Если $e$ содержит начальные вершины одного А-объекта, это обязан быть А-путь, и вставка ребра превращает этот путь в цикл.

Ребро, соединяющее А-синглтон с другим А-объектом (за исключением случая, когда синглтон соединяется со средней вершиной А-пути из трёх вершин -- иначе улучшение типа 4).

Предположим, что нет очень маленького улучшения, и есть ЧП $R$, начинающийся в $u$, а $\{u\}$ --- А-синглтон. Тогда для пути (v, w, x) и некоторого $y$ путь $R$ начинается с $(u, w, v, y)$. Когда мы считаем $R$ возможной частью улучшения, мы берём "сокращённую" версию $R$, начинающуюся с $(v, y)$. С одной стороны, мы забываем, что $R$ начинается с синглтона и поэтому должен собрать лишнюю $\frac{1}{2}$ фишки. С другой стороны, мы забудем, что $R$ собирает $\frac{1}{2}$ фишки на вершине $w$.

\paragraph{Примеры с ЧП}
ЧП сам по себе может задавать улучшение. 

\paragraph{Начальные вершины циклов}
Пусть $C$ --- цикл A с $\ge 7$ вершинами с $|C|$ фишками (т. е., у него все вершины смежны с двумя рёбрами из $B$).

Пусть $\hat{C}$ --- множество вершин из $C$, и $\hat{K} \subset \hat{C}$ --- множество вершин, инцидентных двум чёрным вершинам. 

Покажем, что какие-то две вершины из $\hat{K}$ \textit{совместимы} в том смысле, что они --- концы гамильтонова пути в $\hat{C}$.

Если $|\hat{K}| = 2$, то $\hat{K}$ --- \textit{согласованная пара}, потому что множество рёбер $B$, содержащихся в $C$, образует единственный путь.

Пусть $|\hat{K}| \ge 3$. 
Предположим, что две вершины $\hat{K}$, $u$ и $v$, соседние на цикле $C$. Тогда они согласованы, т. к. мы можем сделать путь, удалив ребро $(u, v)$ из $C$.
Иначе они не смежны, и получаем, что $|\hat{K}| \le |\hat{C}|/2$. Это означает, что $|\hat{K}| = 3$ и $|\hat{C}| = 6$.

Т. к. $\hat{K}$ содержит 3 вершины, $B$ покрывает $\hat{C}$ двумя путями. Один из этих путей содержит 1 вершину и 0 рёбер, другой 5 вершин и 4 ребра. Следовательно, 2 ребра $B$ содержатся в $\hat{C} \setminus \hat{K}$. БОО, $C$ --- цикл $(u_0, \dots, u_5)$, $\hat{K} = \{u_-0, u_2, u_4\}$ и $\{u_1, u_3\} ]in B$. Тогда мы можем обойти $\hat{C}$ так: $(u_0, u_5, u_4, u_3, u_1, u_2)$.

\paragraph{ЧП с дефицитом --- общий метод}
Пусть $R$ - ЧП. По нашим правилам, он собирает $\frac{1}{2}$ фишек за каждую свою вершину, за исключением концов путей и вершин циклов. Мы не всегда собираем больше потому, что каждая из таких вершин может принадлежать больше чем одному ЧП.

Есть несколько методов дать $R$ больше фишек.
Распределить фишки серых вершин.
Разбить ЧП $P$, проходящий через цикл, созданный $R$. Если он короткий, можно слить цикл с A-объектом, содержащим начальную точку $P$. Если он длинный, ему не надо собирать фишки с его рёбер в цикле, и эти фишки можно передать $R$.

\paragraph{Избегаем плохих случаев}
\subparagraph{S-дуги --- Избегаем их или находим им дополнительные фишки}

Дуги, чёрные рёбра, содержащиеся в путях, потенциально проблематичны, так как могут позволить короткому ЧП создать больше циклов, так как они позволяют получить цикл из одного фрагмента A-пути и одного чрного ребра (дуги). В этом случае, в ЧП вокруг этой дуги белые рёбра (или конец пути) (см. рис.) Назовём такую конструкцию S-дугой (short cycle making arc). Число вершин на фрагменте пути, соединяющем концы дуги, назовём длиной дуги.

Избежим создания S-дуг декомпозицией чёрных и белых рёбер в множество ЧП. Когда такого решения ппринять невозможно, мы сможем наделить такие S-дуги серыми вершинами, что даст им дополнительные фишки. 

Чтобы применить эту технику, рассмотрим \textit{цепь} дуг $Q$, которая является путём, образованном дугами, содержащимися в А-пути $P$. Для общности, продлим $P$ в оба направления одним \textit{фиктивным белым ребром}. Будем принимать решение, как соединить элементы цепи со смежными белыми рёбрами, когда будем строить ЧП. Соединение дуги с фиктивным белым ребром неявно делает её начальной вершиной её ЧП.

Решение о разбиении внутри цепи могут быть неоднозначными: пример дальше идёт.: вершина $u$ инцидентна 

Сначала будем брать дугу $a_0 \in Q$ как "наименьшего приоритета". Далее, удостоверимся, что никакая другая дуга в $Q$ не является S-дугой. Стартуя из любого конца $Q$, двигаемся к $a$. Вначале примем произвольное решение на этом конце $Q$. По индукции, рассмотрим конец дуги $a \ne a_0$, для которого мы приняли решение на другом его конце. Если это решение соединило $a$ с белым ребром, направленным от него, на другом конце мы соединим $a$ с белым ребром, направленным к нему, иначе произвольное решение.

Хороший случай 1.
Дуга a в цепи $Q$ \textit{прямо достижима} из конца A-пути, т. е. вершина внутри дуги $a$ соединена чёрным ребром с этим концом. Дадим $a$ наименьший приоритет и не получим при этом неблагоприятных последствий. Если мы хотим создать улучшение, используя ЧП, содержащий S-дугу $a$, мы увеличим количество объектов, создав цикл, но уменьшим его обратно, вставив ребро, которое соединяло дугу с концом пути, и уберём смежное ему из цикла.

Хороший случай 2.
Конец $Q$, смежный его первой дуге $a$, смежен к белому ребру $b$, направленному в $a$. Мы можем оставить $a$ с минимальным приоритетом, и финальное решение, соединяющее $a$ с $b$, будет гарантировать, что это не S-дуга.

Хороший случай 3. 
Вершина $u$ смежна двум дугам $Q$ и двум рёбрам, расположенным как на рис. 4. Мы можем дать $a_0$ минимальный приоритет, и решение в $u$ будет соединять $a_0$ с $e_0$ и $a_1$ с $e_1$, что будет гарантировать, что это никогда не станет S-дугой.

Хороший случай 4.
$Q$ состоит из лишь одной дуги $a$ длины 4, и $a$ становится S-дугой, т. е. $a$ смежна двум серым рёбрам, которые внутри неё (рис. 5). Есть 2 ЧП, один с последовательностью рёбер $\{b_0, e_0, a, e_2, b_3\}$, другой с $\{b_1, e_1, b_2\}$. Поменяем соединения так, чтобы были последовательности $\{b_0, e_0, a, g_1, b_2\}$ и $\{b_1, g_0, a, e_2, b_2\}$, и каждый из этих двух ЧП сможет получить $2\frac{1}{2}$ фишек.

Хороший случай 5. $Q$ содержит две последовательные дуги, различающиеся в длине ровно на 2 (рис. 6). Мы можем дать $b_0$ наименьший приоритет, потому что ситуация почти такая же, как в прямом попадании. В частности, в ЧП можно заменить последовательность рёбер $e_0, b_0, e_1$ "обходным путём" $e_0, b_1, e_2$. 

Следовательно, если $Q$ состоит толььо из одной дуги $a$ и мы делаем её S-дугой, длина $a$ по крайней мере 5, и она смежна двум серым рёбрам внутри себя.

Хороший случай 6.
$Q$ содержит две подряд идущие дуги, $b_0$ и $b_1$, где $b_1$ смежно концу пути $P$ и $b_0$ --- нет (представим, что на рис. 6 ребро $e_2$ есть первое ребро $P$). Тогда мы можем дать наименьший приоритет $b_0$, потому что $b_1$ даёт прямое попадание в $b_0$ в случае, если последний станет S-дугой.

Хороший случай 7.
$Q$ содержит дугу $b$, смежную концу $P$ (рис. 7). Если у нас не случай 2, то ребро $g$ серое, и ребро $e_0$ белое. Будем делать похоже на пункт 4. У нас сесть два ЧП, один начинается с $b, e_0, b_0$, другой имеет фрагмент $b_1, e_1, b_2$. Заменим их, соединив $b$ с $b_1$ вместо $b_0$, последовательность $b, g, b_1$, и соединив $b_0$ с $b_2$, последовательность $b_0, e_0, b, e_1, b_2$. Оба этих новых ЧП используют ребро $b$, но первое удаляет $g$ из $P$ и собирает 1 фишку, и второе удаляет $e_0$ и $e_1$, собирая 2 фишки. 

Цепи, которые не подпадают ни под один из этих случаев, назовём проблемными. Они могут образовать суперцепь, соединённую серыми рёбрами. Если такая цеиь содержит конец $P$, назовём её терминальной. Заметим, что проблемная терминальная цепь не может быть соединена в суперцепь с остальными, потому что она предоставляет соседним цепям прямые попадания.

Терминальная проблемная цепь состоит только из рёбер, смежных концу $u$, потому что мы не можем применить методы случаев 3 и 6, и поскольку 2 и 7 неприменимы, и поскольку другой конец/концы этой дуги /дуг смежны паре серых вершин. Поэтому если эта цепь состоит из одной дуги, ЧП, начинающийся в этом ребре, соберёт $2\frac{1}{2}$ фишек с 3-х серых вершин, и более длинная дуга 
\section{Реализация алгоритма}
\paragraph{Генерация тестов}
Поскольку (см. выше) в (1, 2)-TSP всегда выполняется неравенство треугольника, достаточно сгенерировать граф с рёбрами 1 на каких-то местах, а все остальные рёбра сделать веса 2.

При тестировании результат работы алгоритма сравнивался с результатом работы широко известной программы Concorde, предназначенной для точного решения задачи TSP.

Алгоритм был проверен на двух примерах, заданных вручную. Далее, был сгеренирован граф в форме буквы П, гарантированно имеющий гамильтонов цикл только из единичных рёбер, остальные рёбра в котором были проведены случайно. Далее, алгоритм тестировался на случайном графе модели Эрдеша-Реньи $G(n, p)$ с разными значениями $n$ и $p$, а также на случайном графе модели $G(n, m)$.

Поскольку в расширенной версии статьи утверждение доказано для $K=15$, запуски проводились именно при таком значении $K$.

Запуски показали, что алгоритм очень неэффективен при $n>20$.
\bibliography{bibliography}
\end{document}
